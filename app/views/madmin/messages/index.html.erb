<%= content_for :title, resource.friendly_name.pluralize %>

<header class="header">
  <h1><%= resource.friendly_name.pluralize %></h1>
</header>

<div class="filters mb-4 p-4 card-bg">
  <%= form_with url: resource.index_path, method: :get, class: "flex gap-3 items-end flex-wrap" do |f| %>
    <div>
      <%= f.label :q, "Search", class: "block text-sm font-medium text-dark-300 mb-1" %>
      <%= f.search_field :q, value: params[:q], placeholder: "Search messages...", class: "form-input" %>
    </div>

    <div>
      <%= f.label :role, class: "block text-sm font-medium text-dark-300 mb-1" %>
      <% roles = Message.distinct.order(:role).pluck(:role) %>
      <%= f.select :role,
          options_for_select([["All roles", ""]] + roles.map { |r| [r.titleize, r] }, params[:role]),
          {},
          class: "form-select" %>
    </div>

    <div>
      <%= f.label :created_at_from, "From:", class: "block text-sm font-medium text-dark-300 mb-1" %>
      <%= f.date_field :created_at_from, value: params[:created_at_from], class: "form-input" %>
    </div>

    <div>
      <%= f.label :created_at_to, "To:", class: "block text-sm font-medium text-dark-300 mb-1" %>
      <%= f.date_field :created_at_to, value: params[:created_at_to], class: "form-input" %>
    </div>

    <div class="flex gap-2">
      <%= f.submit "Filter", class: "btn btn-primary" %>
      <% if params[:q].present? || params[:role].present? || params[:created_at_from].present? || params[:created_at_to].present? %>
        <%= link_to "Clear", resource.index_path, class: "btn btn-secondary" %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th><%= sortable :content, "Message" %></th>
        <th><%= sortable :chat_id, "Chat" %></th>
        <th><%= sortable :role, "Role" %></th>
        <th><%= sortable :cost, "Cost" %></th>
        <th><%= sortable :created_at, "Created" %></th>
      </tr>
    </thead>

    <tbody>
      <% @records.each do |record| %>
        <tr>
          <td class="max-w-xs">
            <%= link_to resource.show_path(record), class: "block truncate" do %>
              <%= record.content&.truncate(80) || "[No content]" %>
            <% end %>
          </td>
          <td class="max-w-[200px]">
            <%= link_to "/madmin/chats/#{record.chat_id}", class: "block truncate hover:underline" do %>
              <%= record.chat&.messages&.order(:created_at)&.first&.content&.truncate(40) || "Chat ##{record.chat_id.to_s[0..7]}" %>
            <% end %>
          </td>
          <td>
            <span class="px-2 py-1 text-xs font-medium rounded <%= record.role == 'user' ? 'bg-blue-500/20 text-blue-300' : record.role == 'assistant' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-dark-600 text-dark-300' %>">
              <%= record.role %>
            </span>
          </td>
          <td class="<%= (record.cost || 0) >= 0.01 ? 'text-red-400' : 'text-emerald-400' %>"><%= record.formatted_cost || "-" %></td>
          <td><%= record.created_at.strftime("%-d %B %Y") %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="pagination">
  <% if @pagy.respond_to?(:series_nav) %>
    <%== @pagy.series_nav if @pagy.last > 1 %>
    <%== @pagy.info_tag %>
  <% else %>
    <%== pagy_nav @pagy if @pagy.last > 1 %>
    <%== pagy_info @pagy %>
  <% end %>
</div>
