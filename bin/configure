#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"
require "io/console"
require "yaml"
require "securerandom"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

def prompt(question, default = nil)
  print question
  print " [#{default}]" if default
  print ": "
  answer = $stdin.gets.chomp
  answer.empty? && default ? default : answer
end

def project_name_from_directory
  File.basename(APP_ROOT)
end

def to_class_name(string)
  string.split(/[-_]/).map(&:capitalize).join
end

def to_service_name(string)
  string.gsub(/([A-Z])/, '-\1').downcase.sub(/^-/, "").gsub(/[^a-z0-9-]/, "-")
end

def replace_in_file(file_path, old_content, new_content)
  return unless File.exist?(file_path)

  content = File.read(file_path)
  if content.include?(old_content)
    File.write(file_path, content.gsub(old_content, new_content))
    puts "  ✓ Updated #{file_path}"
  end
end

FileUtils.chdir APP_ROOT do
  puts "═" * 60
  puts "  Rails Project Configuration"
  puts "═" * 60
  puts

  # Check if already configured
  if File.exist?(".configured")
    puts "⚠️  This project appears to be already configured."
    print "Do you want to reconfigure? (y/N): "
    answer = $stdin.gets.chomp
    unless answer.downcase == "y"
      puts "Exiting..."
      exit 0
    end
    puts
  end

  # Get project name
  directory_name = project_name_from_directory
  suggested_name = to_class_name(directory_name)

  puts "Current directory: #{directory_name}"
  project_name = prompt("Project name (CamelCase)", suggested_name)
  project_name = to_class_name(project_name) # Ensure proper format
  service_name = to_service_name(project_name)

  puts "\n── Deployment Configuration... ──\n"

  domain = prompt("App domain (e.g., myapp.example.com)", "app.example.com")
  server_ip = prompt("Server IP address", "192.168.0.1")

  puts "\n── SMTP Configuration (optional)... ──\n"
  puts "Press Enter to skip if you want to configure later.\n"

  smtp_address = prompt("SMTP server address (e.g., smtp.postmarkapp.com)")
  smtp_username = ""
  smtp_password = ""
  unless smtp_address.empty?
    smtp_username = prompt("SMTP username")
    smtp_password = prompt("SMTP password")
  end

  # Extract base domain from the full domain for mailer from address
  domain_parts = domain.split(".")
  base_domain = domain_parts.length > 2 ? domain_parts[-2..].join(".") : domain
  mailer_from = prompt("Mailer from address", "noreply@#{base_domain}")

  puts "\n── Renaming project from Template to #{project_name}... ──\n"

  # Update config/application.rb
  replace_in_file(
    "config/application.rb",
    "module Template",
    "module #{project_name}"
  )

  # Update Rakefile
  replace_in_file(
    "Rakefile",
    "Template::Application",
    "#{project_name}::Application"
  )

  # Update config/environments/*.rb
  %w[development test production].each do |env|
    replace_in_file(
      "config/environments/#{env}.rb",
      "Template::Application",
      "#{project_name}::Application"
    )
  end

  # Update config.ru
  replace_in_file(
    "config.ru",
    "Template::Application",
    "#{project_name}::Application"
  )

  # Update bin/rails
  replace_in_file(
    "bin/rails",
    'APP_PATH = File.expand_path("../config/application", __dir__)',
    "APP_PATH = File.expand_path(\"../config/application\", __dir__)"
  )

  # Update package.json if exists
  if File.exist?("package.json")
    replace_in_file(
      "package.json",
      '"name": "template"',
      "\"name\": \"#{directory_name}\""
    )
  end

  puts "\n── Configuring deploy files... ──\n"

  # Update config/deploy.yml
  replace_in_file("config/deploy.yml", "service: template", "service: #{service_name}")
  replace_in_file("config/deploy.yml", "image: template", "image: #{service_name}")
  replace_in_file("config/deploy.yml", "host: app.example.com", "host: #{domain}")
  replace_in_file("config/deploy.yml", "- 192.168.0.1", "- #{server_ip}")
  replace_in_file("config/deploy.yml", "template_storage:/rails/storage", "#{service_name}_storage:/rails/storage")

  # Update config/environments/production.rb
  replace_in_file("config/environments/production.rb", 'host: "app.example.com"', "host: \"#{domain}\"")
  replace_in_file("config/environments/production.rb", '"app.example.com"', "\"#{domain}\"")
  replace_in_file("config/environments/production.rb", '/.*\.example\.com/', "/.*\\.#{Regexp.escape(base_domain).gsub('\\.', '\\.')}/")
  # SMTP address comes from credentials - no file replacement needed

  # Update Dockerfile comment
  replace_in_file("Dockerfile", "docker build -t template", "docker build -t #{service_name}")
  replace_in_file("Dockerfile", "--name template template", "--name #{service_name} #{service_name}")

  puts "\n── Configuring first admin... ──\n"

  admin_email = prompt("Admin email address", "admin@#{base_domain}")

  puts "\n── Configuring AI API Keys (optional)... ──\n"
  puts "RubyLLM supports OpenAI and Anthropic (Claude) APIs."
  puts "Press Enter to skip if you want to configure them later.\n"

  openai_api_key = prompt("OpenAI API Key")
  anthropic_api_key = prompt("Anthropic (Claude) API Key")

  puts "\n── Configuring Litestream (optional)... ──\n"
  puts "Litestream provides SQLite replication to S3-compatible storage."
  puts "Press Enter to skip if you don't need it yet.\n"

  replica_bucket = prompt("S3 bucket name (e.g., my-app-backups)")
  replica_key_id = prompt("S3 Access Key ID") unless replica_bucket.empty?
  replica_access_key = prompt("S3 Secret Access Key") unless replica_bucket.empty?

  # Store config temporarily
  config_data = {
    "admin_email" => admin_email,
    "mailer_from" => mailer_from,
    "smtp_address" => smtp_address,
    "smtp_username" => smtp_username,
    "smtp_password" => smtp_password,
    "openai_api_key" => openai_api_key,
    "anthropic_api_key" => anthropic_api_key,
    "replica_bucket" => replica_bucket,
    "replica_key_id" => replica_key_id,
    "replica_access_key" => replica_access_key
  }
  File.write(".configure_temp.yml", YAML.dump(config_data))

  # Update seeds file with admin email
  seeds_content = <<~RUBY
    # This file should ensure the existence of records required to run the application in every environment (production,
    # development, test). The code here should be idempotent so that it can be executed at any point in every environment.
    # The data can then be loaded with the bin/rails db:seed command (or created alongside the database with db:setup).

    # Create first admin
    admin = Admin.find_or_create_by!(email: "#{admin_email}")
    puts "✓ Admin created: \#{admin.email}"
  RUBY

  File.write("db/seeds.rb", seeds_content)
  puts "  ✓ Updated db/seeds.rb"

  puts "\n── Writing credentials... ──\n"

  # Load config data
  config_data = YAML.load_file(".configure_temp.yml")

  # Build credentials hash
  credentials_hash = {
    "secret_key_base" => SecureRandom.hex(64),
    "mailer" => { "from_address" => config_data["mailer_from"] }
  }

  # Add SMTP credentials if provided
  # Add SMTP credentials if provided
  if !config_data["smtp_address"].to_s.empty?
    credentials_hash["smtp"] = {
      "address" => config_data["smtp_address"],
      "username" => config_data["smtp_username"],
      "password" => config_data["smtp_password"]
    }
  end

  # Add AI credentials if provided
  credentials_hash["openai"] = { "api_key" => config_data["openai_api_key"] } unless config_data["openai_api_key"].to_s.empty?
  credentials_hash["anthropic"] = { "api_key" => config_data["anthropic_api_key"] } unless config_data["anthropic_api_key"].to_s.empty?

  # Add Litestream credentials if provided
  if !config_data["replica_bucket"].to_s.empty?
    credentials_hash["litestream"] = {
      "replica_bucket" => config_data["replica_bucket"],
      "replica_key_id" => config_data["replica_key_id"],
      "replica_access_key" => config_data["replica_access_key"]
    }
  end

  require "active_support/encrypted_configuration"
  FileUtils.mkdir_p("config/credentials")

  # Write to both development and production credentials
  %w[development production].each do |env|
    key_path = "config/credentials/#{env}.key"
    credentials_path = "config/credentials/#{env}.yml.enc"

    # Generate key if it doesn't exist
    unless File.exist?(key_path)
      key = ActiveSupport::EncryptedConfiguration.generate_key
      File.write(key_path, key)
      puts "  ✓ Generated #{env} key: #{key_path}"
    end

    # Write the credentials
    config = ActiveSupport::EncryptedConfiguration.new(
      config_path: credentials_path,
      key_path: key_path,
      env_key: "RAILS_MASTER_KEY",
      raise_if_missing_key: false
    )

    config.write(YAML.dump(credentials_hash))
    puts "  ✓ #{env.capitalize} credentials updated: #{credentials_path}"
  end

  # Clean up temp files
  File.delete(".configure_temp.yml") if File.exist?(".configure_temp.yml")

  # Mark as configured
  File.write(".configured", "Configured on #{Time.now}\nProject: #{project_name}\nDomain: #{domain}\nAdmin: #{admin_email}\n")

  puts "\n" + "═" * 60
  puts "  ✓ Configuration Complete!"
  puts "═" * 60
  puts
  puts "Project: #{project_name}"
  puts "Domain:  #{domain}"
  puts "Server:  #{server_ip}"
  puts "Admin:   #{admin_email}"
  puts
  puts "Running bin/setup to install dependencies and setup database..."
  puts

  # Run bin/setup (after credentials are written)
  system!("bin/setup")

  puts "\n" + "═" * 60
  puts "  ✓ All Done!"
  puts "═" * 60
  puts
  puts "Next steps:"
  puts "  1. Run: bin/dev"
  puts "  2. Visit: /admins/session/new"
  puts "  3. Request magic link for: #{admin_email}"
  puts "  4. Check your email and click the magic link"
  puts "  5. Access Madmin admin panel at: /madmin"
  puts
end
